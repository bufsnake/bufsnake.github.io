<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="有梦就去追，没死就别停">
  <meta name="author" content="bufsnake">
  <meta name="keywords" content="web安全,逆向,ctf,pwn,crypto,misc,android,安卓,破解,底层">
  <title>ISCC 逆向 WP ~ bufsnake</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">


</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>bufsnake</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" false
         style="background: url('/img/default.webp')no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期四, 五月 28日 2020, 7:06 晚上
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    3.7k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      20 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h3 id="无标点日记"><a href="#无标点日记" class="headerlink" title="无标点日记"></a>无标点日记</h3><pre><code class="c">void __cdecl __noreturn sub_401190(char *a1)
{
  int v1; // [esp+4Ch] [ebp-Ch]
  signed int i; // [esp+54h] [ebp-4h]

  if ( strlen(a1) == 16 )
  {
    for ( i = 0; i &lt; 16; ++i )
    {
      v1 = i + a1[i] - unk_432A60[i] + 19;      // i + input[i] - byte[i] + 19
      if ( v1 &lt;= 0 )
      {
        sub_40100F(OhhMywifewaslost);           // OhhMywifewaslost
      }
      else if ( OhhMywifewaslost[i] != unk_432A73[v1] )
      {
        sub_40100F(OhhMywifewaslost);
      }
    }
  }
  sub_401005();
}
</code></pre>
<p><code>sub_40100F</code>对字符串<code>&quot;OhhMywifewaslost&quot;</code>进行操作。</p>
<p>根据用户输入的16个字符，判断每个字符对应的v1是否进行加密。</p>
<pre><code class="python">puzzle = [0x00,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A]
Oh = &#39;OhhMywifewaslost&#39;
aaaa = [ 0x29, 0x6A, 0x68, 0x46, 0x66, 0x5B, 0x67, 0x7D, 0x6F, 0x6D, 0x77, 0x62, 0x76, 0x28, 0x25, 0x25]
flag = &#39;&#39;
for i in range(0,16):
    for inputs in range(0,255):
        v = i + inputs - aaaa[i] + 19
        if v &gt; 0 and v &lt; len(puzzle):
            if puzzle[v] == ord(Oh[i]):
                flag += chr(inputs)
                print(flag)

// Iheardascream!!!                
</code></pre>
<p><code>&quot;Iheardascream!!!&quot;</code>字符串的每一位都表示不经过<code>sub_40100F</code></p>
<pre><code class="bash">C:\Users\Bufsnake\Desktop&gt;puzzle.exe
Iheardaloudnoise
and Iheardascream!!!
get{OhhMywifewaslost}
</code></pre>
<p>所以可以在此基础上控制<code>&quot;OhhMywifewaslost&quot;</code>是否经过<code>sub_40100F</code>，以及经过的次数.</p>
<pre><code class="bash"># 加密一次的情况
C:\Users\Bufsnake\Desktop&gt;puzzle.exe
Iheardaloudnoise
and Iheardascream!!a
get{Wearecockroaches}
# 加密二次的情况
C:\Users\Bufsnake\Desktop&gt;puzzle.exe
Iheardaloudnoise
and Iheardascream!aa
get{甧皽?{嵵r稾l?蛚
...
</code></pre>
<p>Flag:flag{Wearecockroaches}</p>
<h3 id="flag是好长好长的一段数字"><a href="#flag是好长好长的一段数字" class="headerlink" title="flag是好长好长的一段数字"></a>flag是好长好长的一段数字</h3><p>主活动代码如下</p>
<pre><code class="java">package com.example.myapplication;

import android.os.Bundle;
import android.util.Base64;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;

public class MainActivity extends AppCompatActivity {

    /* renamed from: e */
    String f32e;

    /* access modifiers changed from: protected */
    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView((int) C0274R.layout.activity_main);
        final EditText editText = (EditText) findViewById(C0274R.C0276id.text);
        final EditText editText2 = (EditText) findViewById(C0274R.C0276id.text1);
        Button button = (Button) findViewById(C0274R.C0276id.button1);
        ((Button) findViewById(C0274R.C0276id.button)).setOnClickListener(new OnClickListener() {
            public void onClick(View view) {
                if (MainActivity.this.check(editText.getText().toString())) {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;用户名正确！&quot;, 1).show();
                } else {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;用户名错误！！&quot;, 1).show();
                }
            }
        });
        button.setOnClickListener(new OnClickListener() {
            public void onClick(View view) {
                String obj = editText2.getText().toString();
                MainActivity mainActivity = MainActivity.this;
                if (mainActivity.check2(obj, mainActivity.f32e)) {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;success!!&quot;, 1).show();
                } else {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;defeated!&quot;, 1).show();
                }
            }
        });
    }

    /* access modifiers changed from: 0000 */
    public boolean check(String str) {
        if (str.length() == 0) {
            return false;
        }
        String lowerCase = Base64.encodeToString(str.getBytes(), 0).toLowerCase();
        this.f32e = lowerCase;
        if (lowerCase.substring(3, 9).equals(&quot;dqy1ba&quot;)) {
            return true;
        }
        return false;
    }

    /* access modifiers changed from: 0000 */
    public boolean check2(String str, String str2) {
        String str2HexStr = str2HexStr(str2);
        StringBuilder sb = new StringBuilder();
        sb.append(str2HexStr);
        sb.append(str);
        return checkcode(sb.toString()).equals(&quot;5731d798714022433553234173&quot;);
    }

    public String checkcode(String str) {
        String[] strArr = new String[15];
        try {
            strArr[0] = str.substring(0, 2);
            strArr[1] = str.substring(2, 4);
            strArr[2] = str.substring(4, 6);
            strArr[3] = str.substring(6, 8);
            strArr[4] = str.substring(8, 10);
            strArr[5] = str.substring(10, 12);
            strArr[6] = str.substring(12, 14);
            strArr[7] = str.substring(14, 16);
            strArr[8] = str.substring(16, 18);
            strArr[9] = str.substring(18, 20);
            strArr[10] = str.substring(20, 22);
            strArr[11] = str.substring(22, 24);
            strArr[12] = str.substring(24, 26);
            strArr[13] = str.substring(26, 28);
            strArr[14] = str.substring(28, 30);
        } catch (Exception unused) {
        }
        String str2 = BuildConfig.FLAVOR;
        String str3 = str2;
        for (int i = 0; i &lt; 14; i++) {
            if (i == 0) {
                str3 = xor(strArr[i], strArr[i + 1]);
                StringBuilder sb = new StringBuilder();
                sb.append(str2);
                sb.append(str3);
                str2 = sb.toString();
            } else {
                str3 = xor(str3, strArr[i]);
                StringBuilder sb2 = new StringBuilder();
                sb2.append(str2);
                sb2.append(str3);
                str2 = sb2.toString();
            }
        }
        return str2;
    }

    private static String xor(String str, String str2) {
        String binaryString = Integer.toBinaryString(Integer.valueOf(str, 16).intValue());
        String binaryString2 = Integer.toBinaryString(Integer.valueOf(str2, 16).intValue());
        String str3 = &quot;0&quot;;
        if (binaryString.length() != 8) {
            for (int length = binaryString.length(); length &lt; 8; length++) {
                StringBuilder sb = new StringBuilder();
                sb.append(str3);
                sb.append(binaryString);
                binaryString = sb.toString();
            }
        }
        if (binaryString2.length() != 8) {
            for (int length2 = binaryString2.length(); length2 &lt; 8; length2++) {
                StringBuilder sb2 = new StringBuilder();
                sb2.append(str3);
                sb2.append(binaryString2);
                binaryString2 = sb2.toString();
            }
        }
        String str4 = BuildConfig.FLAVOR;
        for (int i = 0; i &lt; binaryString.length(); i++) {
            if (binaryString2.charAt(i) == binaryString.charAt(i)) {
                StringBuilder sb3 = new StringBuilder();
                sb3.append(str4);
                sb3.append(str3);
                str4 = sb3.toString();
            } else {
                StringBuilder sb4 = new StringBuilder();
                sb4.append(str4);
                sb4.append(&quot;1&quot;);
                str4 = sb4.toString();
            }
        }
        Log.e(&quot;code&quot;, str4);
        return Integer.toHexString(Integer.parseInt(str4, 2));
    }

    public static String str2HexStr(String str) {
        char[] charArray = &quot;0123456789abcdef&quot;.toCharArray();
        StringBuilder sb = new StringBuilder(BuildConfig.FLAVOR);
        byte[] bytes = str.getBytes();
        for (int i = 0; i &lt; bytes.length; i++) {
            sb.append(charArray[(bytes[i] &amp; 240) &gt;&gt; 4]);
            sb.append(charArray[bytes[i] &amp; 15]);
        }
        return sb.toString().trim();
    }
}
</code></pre>
<p>通过<code>dqy1ba</code>中的<code>qy1b</code>解密得到<code>C-A</code>结合比赛名称与出题者，可得知用户名为<code>ISCC-AiQiong</code>，并且由于<code>ISCC-AiQiong</code>经过加密后长度足够长，导致checkcode的时候不会判断注册码是否正确，只会判断用户名，无论输入什么注册码都会成功。但不知道flag到底是个啥。</p>
<p>后来更新了题目附件</p>
<pre><code class="java">package com.example.myapplication;

import android.os.Bundle;
import android.util.Base64;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;

public class MainActivity extends AppCompatActivity {

    /* renamed from: e */
    String f32e;

    /* access modifiers changed from: protected */
    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView((int) C0274R.layout.activity_main);
        final EditText editText = (EditText) findViewById(C0274R.C0276id.text);
        final EditText editText2 = (EditText) findViewById(C0274R.C0276id.text1);
        Button button = (Button) findViewById(C0274R.C0276id.button1);
        ((Button) findViewById(C0274R.C0276id.button)).setOnClickListener(new OnClickListener() {
            public void onClick(View view) {
                if (MainActivity.this.check(editText.getText().toString())) {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;用户名正确！&quot;, 1).show();
                } else {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;用户名错误！！&quot;, 1).show();
                }
            }
        });
        button.setOnClickListener(new OnClickListener() {
            public void onClick(View view) {
                if (MainActivity.this.check2(editText2.getText().toString())) {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;success!!&quot;, 1).show();
                } else {
                    Toast.makeText(MainActivity.this.getApplicationContext(), &quot;defeated!&quot;, 1).show();
                }
            }
        });
    }

    /* access modifiers changed from: 0000 */
    public boolean check(String str) {
        if (str.length() == 0) {
            return false;
        }
        String lowerCase = Base64.encodeToString(str.getBytes(), 0).toLowerCase();
        this.f32e = lowerCase;
        if (lowerCase.substring(3, 9).equals(&quot;dqy1ba&quot;)) {
            return true;
        }
        return false;
    }

    /* access modifiers changed from: 0000 */
    public boolean check2(String str) {
        return checkcode(str2HexStr(str)).equals(&quot;23243673763173613543db&quot;);
    }

    public String checkcode(String str) {
        String[] strArr = new String[15];
        try {
            strArr[0] = str.substring(0, 2);
            strArr[1] = str.substring(2, 4);
            strArr[2] = str.substring(4, 6);
            strArr[3] = str.substring(6, 8);
            strArr[4] = str.substring(8, 10);
            strArr[5] = str.substring(10, 12);
            strArr[6] = str.substring(12, 14);
            strArr[7] = str.substring(14, 16);
            strArr[8] = str.substring(16, 18);
            strArr[9] = str.substring(18, 20);
            strArr[10] = str.substring(20, 22);
            strArr[11] = str.substring(22, 24);
            strArr[12] = str.substring(24, 26);
            strArr[13] = str.substring(26, 28);
            strArr[14] = str.substring(28, 30);
        } catch (Exception unused) {
        }
        String str2 = BuildConfig.FLAVOR;
        String str3 = str2;
        for (int i = 0; i &lt; 15; i++) {
            if (i == 0) {
                str3 = xor(strArr[i], strArr[i + 1]);
                StringBuilder sb = new StringBuilder();
                sb.append(str2);
                sb.append(str3);
                str2 = sb.toString();
            } else {
                str3 = xor(str3, strArr[i]);
                StringBuilder sb2 = new StringBuilder();
                sb2.append(str2);
                sb2.append(str3);
                str2 = sb2.toString();
            }
        }
        return str2;
    }

    private static String xor(String str, String str2) {
        String binaryString = Integer.toBinaryString(Integer.valueOf(str, 16).intValue());
        String binaryString2 = Integer.toBinaryString(Integer.valueOf(str2, 16).intValue());
        String str3 = &quot;0&quot;;
        if (binaryString.length() != 8) {
            for (int length = binaryString.length(); length &lt; 8; length++) {
                StringBuilder sb = new StringBuilder();
                sb.append(str3);
                sb.append(binaryString);
                binaryString = sb.toString();
            }
        }
        if (binaryString2.length() != 8) {
            for (int length2 = binaryString2.length(); length2 &lt; 8; length2++) {
                StringBuilder sb2 = new StringBuilder();
                sb2.append(str3);
                sb2.append(binaryString2);
                binaryString2 = sb2.toString();
            }
        }
        String str4 = BuildConfig.FLAVOR;
        for (int i = 0; i &lt; binaryString.length(); i++) {
            if (binaryString2.charAt(i) == binaryString.charAt(i)) {
                StringBuilder sb3 = new StringBuilder();
                sb3.append(str4);
                sb3.append(str3);
                str4 = sb3.toString();
            } else {
                StringBuilder sb4 = new StringBuilder();
                sb4.append(str4);
                sb4.append(&quot;1&quot;);
                str4 = sb4.toString();
            }
        }
        return Integer.toHexString(Integer.parseInt(str4, 2));
    }

    public static String str2HexStr(String str) {
        char[] charArray = &quot;0123456789abcdef&quot;.toCharArray();
        StringBuilder sb = new StringBuilder(BuildConfig.FLAVOR);
        byte[] bytes = str.getBytes();
        for (int i = 0; i &lt; bytes.length; i++) {
            sb.append(charArray[(bytes[i] &amp; 240) &gt;&gt; 4]);
            sb.append(charArray[bytes[i] &amp; 15]);
        }
        return sb.toString().trim();
    }
}
</code></pre>
<p>改动还挺大</p>
<p><img src="images/writeup.assets/image-20200504004413633.png" srcset="/img/loading.gif" alt="image-20200504004413633"></p>
<p>用户名还是输入<code>ISCC-AiQiong</code>，但是用户名输入的这次改变不了注册码。</p>
<p><code>23243673763173613543db</code>长度为22，因为加密后的结果如果为0x0b，则只会返回’b’字符，需要填充8个0，但是不知道填在哪8个位置。</p>
<pre><code class="python">import z3

solve = z3.Solver()
s = []
for i in range(0,15):
    s.append(z3.BitVec(&#39;s[%d]&#39;%i,8))

# 23243673763173613543db

for i in s:
    solve.add(i &gt;= ord(&#39;0&#39;))
    solve.add(i &lt;= ord(&#39;9&#39;))
solve.add(s[0] ^ s[1] == 2)   // 因为都为数字，所以第一位和第二位 xor 得到的结果肯定小于0xf
solve.add(2 ^ s[1] == 0x32)   // 逐步探测 0x32 或 0x3
solve.add(0x32 ^ s[2] == 0x4) // 发现规律，0，2，4，6...需要在前面添加&#39;0&#39;
solve.add(0x4 ^ s[3] == 0x36)
solve.add(0x36 ^ s[4] == 0x7)
solve.add(0x7 ^ s[5] == 0x37)
solve.add(0x37 ^ s[6] == 0x6)
solve.add(0x6 ^ s[7] == 0x31)
solve.add(0x31 ^ s[8] == 0x7)
solve.add(0x7 ^ s[9] == 0x36)
solve.add(0x36 ^ s[10] == 0x1)
solve.add(0x1 ^ s[11] == 0x35)
solve.add(0x35 ^ s[12] == 0x4)
solve.add(0x4 ^ s[13] == 0x3d)
solve.add(0x3d ^ s[14] == 0xb)
solve.add(s[0] ^ s[1] ^ s[1] ^ s[2] ^ s[3] ^ s[4] ^ s[5] ^ s[6] ^ s[7] ^ s[8] ^ s[9] ^ s[10] ^ s[11] ^ s[12] ^ s[13] ^ s[14] == 0xb)
if solve.check() == z3.sat:
    for i in range(0,15):
        print(solve.model()[s[i]],&quot;,&quot;,end=&#39;&#39;)

print(&#39;&#39;)
flag = [50 ,48 ,54 ,50 ,49 ,48 ,49 ,55 ,54 ,49 ,55 ,52 ,49 ,57 ,54]
print(&#39;&#39;.join(chr(i) for i in flag))
// flag{206210176174196}
</code></pre>
<h3 id="苏大强的保险箱-01"><a href="#苏大强的保险箱-01" class="headerlink" title="苏大强的保险箱-01"></a>苏大强的保险箱-01</h3><pre><code class="python">In [1]: b = [0xD5, 0x9E, 0xB4, 0x70, 0x78, 0x60, 0x82, 0x70, 0x39, 0x5E]

In [2]: a = [0x0A, 0x07, 0x41, 0x0B, 0x2C, 0x0C, 0x3D, 0x38, 0x27, 0x73]

In [3]: m = []

In [4]: for i in range(len(a)):
   ...:     m.append(b[9-i] -i -a[i])
   ...:

In [5]: m
Out[5]: [84, 49, 45, 116, 48, 103, 45, 117, 111, 89]

In [6]: &#39;&#39;.join(chr(i) for i in m)
Out[6]: &#39;T1-t0g-uoY&#39;

In [7]: m.reverse()

In [8]: &#39;&#39;.join(chr(i) for i in m)
Out[8]: &#39;You-g0t-1T&#39;
</code></pre>
<h3 id="Never-Give-Up"><a href="#Never-Give-Up" class="headerlink" title="Never Give Up"></a>Never Give Up</h3><p>文件格式错误，需要修改，经过查阅资料，发现损坏的是dex文件，dex文件有个关键字<code>xV4</code>搜索发现存在两处，修改如下：</p>
<p><img src="images/writeup.assets/image-20200504183507982.png" srcset="/img/loading.gif" alt="image-20200504183507982"></p>
<p>使用dex2jar将dex转成jar文件。</p>
<p>使用jadx打开jar文件，如下图，可以成功反编译</p>
<p><img src="images/writeup.assets/image-20200504183652468.png" srcset="/img/loading.gif" alt="image-20200504183652468"></p>
<p><img src="images/writeup.assets/image-20200504215457540.png" srcset="/img/loading.gif" alt="image-20200504215457540"></p>
<p>分析程序得到</p>
<pre><code class="python">ZIP压缩(AES(SHA256(15431516836),flag)) == &quot;XXXXXXXXXXXD7BA396A2249B7AE45CDC9D09DB16BE5C56DAB147F3CC8172BDF8DAC95545737AB5BB01163F10AA&quot;
</code></pre>
<p>可以发现经过zip压缩之后前12个字符是固定的，所以</p>
<pre><code class="c">&quot;78BBA4F709ED7BA396A2249B7AE45CDC9D09DB16BE5C56DAB147F3CC8172BDF8DAC95545737AB5BB01163F10AA&quot;
</code></pre>
<p>可以得到</p>
<pre><code class="python">ZIP压缩(AES(&quot;890af61d119e419329e5c660d4ec92a850544e101a7142d1b653836fddd942eb&quot;,flag)) = &quot;78BBA4F709ED7BA396A2249B7AE45CDC9D09DB16BE5C56DAB147F3CC8172BDF8DAC95545737AB5BB01163F10AA&quot;
</code></pre>
<p>解密代码如下</p>
<pre><code class="java">import java.io.UnsupportedEncodingException;
import javax.crypto.spec.SecretKeySpec;
import javax.crypto.Cipher;
import javax.crypto.KeyGenerator;
import javax.crypto.*;
import java.security.SecureRandom;
import java.io.ByteArrayOutputStream;
import java.util.zip.DataFormatException;
import java.util.zip.Deflater;
import java.util.zip.Inflater;

public class output {
    public static void main(String[] args){
        byte[] output = new byte[1024];
        output = J(G(&quot;78BBA4F709ED7BA396A2249B7AE45CDC9D09DB16BE5C56DAB147F3CC8172BDF8DAC95545737AB5BB01163F10AA&quot;));
        output = decrypt(output,G(&quot;890AF61D119E419329E5C660D4EC92A850544E101A7142D1B653836FDDD942EB&quot;));
        for (byte b : output) {
            System.out.print((char)b);
        }
    }
    public static byte[] G(String str) {
        int length = str.length() / 2;
        byte[] bArr = new byte[length];
        for (int i = 0; i &lt; length; i++) {
            bArr[i] = Integer.valueOf(str.substring(i * 2, (i * 2) + 2), 16).byteValue();
        }
        return bArr;
    }

    public static byte[] J(byte[] bArr) {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(bArr.length);
        Inflater inflater = new Inflater();
        try {
            inflater.setInput(bArr);
            byte[] bArr2 = new byte[64];
            while (!inflater.finished()) {
                int inflate = inflater.inflate(bArr2);
                if (inflate == 0) {
                    inflater.setDictionary(&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;.getBytes());
                } else {
                    byteArrayOutputStream.write(bArr2, 0, inflate);
                }
            }
        } catch (DataFormatException e) {
            e.printStackTrace();
        } finally {
            inflater.end();
        }
        return byteArrayOutputStream.toByteArray();
    }
    public static byte[] decrypt(byte[] cipherBytes, byte[] key){
        try{
            // 生成密钥对象
            SecretKey secKey = new SecretKeySpec(key, &quot;AES&quot;);
            // 获取 aes 密码器
            Cipher cipher = Cipher.getInstance(&quot;AES&quot;);
            // 初始化密码器（解密模型）
      // 1 是加密模式CIPHER.ENCRYPT_MODE
      // 2 是解密模式CIPHER.DECRYPT_MODE
            cipher.init(2,secKey); // 
            // 解密数据, 返回明文
            return cipher.doFinal(cipherBytes);
        }catch(Exception e) {
            System.out.println(&quot;\n&quot;+e);
        }
        byte a[] = {1,2,3};
        return a;
    }
}
// flag{L1r3n5u0xI4n9J15h1}
</code></pre>
<h3 id="Obfu"><a href="#Obfu" class="headerlink" title="Obfu"></a>Obfu</h3><p>查看函数列表发现encode1，调用其的地址在那9999个函数中，猜测只有它参与了加密，9999个函数只是幌子。</p>
<p><img src="images/writeup.assets/image-20200502211429540.png" srcset="/img/loading.gif" alt="image-20200502211429540"></p>
<p>测试在文件中输入32个’1’。</p>
<p><img src="images/writeup.assets/image-20200502211508348.png" srcset="/img/loading.gif" alt="image-20200502211508348"></p>
<p>在encode2前下个断点，得到的数据和encode1后得到的数据是相同的。</p>
<p><img src="images/writeup.assets/image-20200502211931405.png" srcset="/img/loading.gif" alt="image-20200502211931405"></p>
<p><img src="images/writeup.assets/image-20200502211330739.png" srcset="/img/loading.gif" alt="image-20200502211330739"></p>
<p>接下来分析encode2函数</p>
<p>变种的腾讯tea加密 <code>de1ta = 0xdeadbeef</code></p>
<p>获取当前时间戳，通过以下代码得到key值</p>
<pre><code class="c">v3 = 0;
printf(&quot;Your Key %X,But I Can&#39;t Give It To You.\n&quot;, v0);
result = (v0 ^ 0xDEADBEEF);
v2 = v0 ^ 0xDEADBEEF;
for ( i = 0; i &lt;= 3; ++i )
{
  for ( j = 0; j &lt;= 31; ++j )
    v3 ^= (v2 &gt;&gt; j) &amp; 1;
  v2 = v3 | 2 * v2;
  result = i;
  *(&amp;key + i) = v2;
}
</code></pre>
<p>每8位一组将32位加密</p>
<pre><code class="c">for ( k = 0; k &lt;= 31; k += 8 )
  result = EncryptTEA((k + 8605856LL), (k + 4 + 8605856LL), &amp;key);
</code></pre>
<p>解密代码如下</p>
<pre><code class="python">def get_key(time):
    key = []
    v2 = time ^ 0xDEADBEEF
    v3 = 0
    for j in range(0,4):
        for k in range(0,32):
            v3 = v3 ^ (v2 &gt;&gt; k) &amp; 1
        v2 = (v3 | (v2 &lt;&lt; 1)) &amp; 0xffffffff
        key.append(v2)
    return key

def replace_3_5(byte):
    byte = ((byte &gt;&gt; 5) | (byte &lt;&lt; 3)) &amp; 0xff
    return byte

def decode(first,second,key):
    num = (0xdeadbeef &lt;&lt; 4) &amp; 0xffffffff
    for i in range(0,16):
        one = (first + num) &amp; 0xffffffff
        two = ((first &lt;&lt; 3) + key[2]) &amp; 0xffffffff
        thr = ((first &gt;&gt; 6) + key[3]) &amp; 0xffffffff
        second = (second - (one ^ two ^ thr)) &amp; 0xffffffff
        one = (second + num) &amp; 0xffffffff
        two = ((second &lt;&lt; 3) + key[0]) &amp; 0xffffffff
        thr = ((second &gt;&gt; 6) + key[1]) &amp; 0xffffffff
        first = (first - (one ^ two ^ thr))&amp;0xffffffff
        num = (num - 0xdeadbeef) &amp; 0xffffffff
    dec.append(first)
    dec.append(second)

inputs = [0xba,0x7f,0x1c,0xea,0xc0,0x1a,0x4b,0xdf,0x0d,0xb0,0x57,0xb6,0x05,0x27,0x2c,0x80,0x20,0x6a,0x21,0x72,0x54,0x28,0x46,0x68,0x07,0xfe,0x36,0xa3,0xff,0xda,0x60,0x75]
for ti in range(1588266000,1588431600):
    key = get_key(ti)
    for i in range(0,32,8):
        first = int(hex(inputs[i+3])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i+2])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i+1])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i])[2:].rjust(2,&#39;0&#39;),16)
        second = int(hex(inputs[i+7])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i+6])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i+5])[2:].rjust(2,&#39;0&#39;) + hex(inputs[i+4])[2:].rjust(2,&#39;0&#39;),16)
        decode(first,second,key)
    decode_data = []
    for i in range(0,len(dec)):
        temp = hex(dec[i])[2:].rjust(8,&#39;0&#39;)
        decode_data.append(int(temp[6:8],16))
        decode_data.append(int(temp[4:6],16))
        decode_data.append(int(temp[2:4],16))
        decode_data.append(int(temp[0:2],16))
    for i in range(len(decode_data)):
        print(chr(replace_3_5(decode_data[i])),end=&#39;&#39;)
    print(&#39;&#39;)
    dec = []
# flag{CI3vEr_T0_FlNd_tlMe_sS^Ff!}
</code></pre>
<p>需要爆破时间戳，这里从2020-05-01 0:0:0开始爆破 到 2020-05-02 23:0:0，可以爆破到2020-05-02 11:33:15加密的flag，也可以直接得到flag值。</p>
<p><img src="images/writeup.assets/image-20200504000354079.png" srcset="/img/loading.gif" alt="image-20200504000354079"></p>
<p>坑点：python 整形、python运算优先级以及大小端问题</p>
<h3 id="苏大强的保险箱-2"><a href="#苏大强的保险箱-2" class="headerlink" title="苏大强的保险箱-2"></a>苏大强的保险箱-2</h3><pre><code class="c">int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int v3; // eax
  size_t v4; // rbx
  int v6[12]; // [rsp+20h] [rbp-60h]
  int v7; // [rsp+50h] [rbp-30h]
  int v8; // [rsp+54h] [rbp-2Ch]
  int v9; // [rsp+58h] [rbp-28h]
  int v10; // [rsp+5Ch] [rbp-24h]
  int v11; // [rsp+60h] [rbp-20h]
  int v12; // [rsp+64h] [rbp-1Ch]
  int v13; // [rsp+68h] [rbp-18h]
  int v14; // [rsp+6Ch] [rbp-14h]
  int v15; // [rsp+70h] [rbp-10h]
  int v16; // [rsp+74h] [rbp-Ch]
  int v17; // [rsp+78h] [rbp-8h]
  int v18; // [rsp+7Ch] [rbp-4h]
  unsigned __int8 v19[256]; // [rsp+A0h] [rbp+20h]
  unsigned __int8 v20[256]; // [rsp+1A0h] [rbp+120h]
  char Str2[8]; // [rsp+2A0h] [rbp+220h]
  char Str[16]; // [rsp+2C0h] [rbp+240h]
  char Buffer; // [rsp+2D0h] [rbp+250h]
  unsigned int v24; // [rsp+2F0h] [rbp+270h]
  int j; // [rsp+2F4h] [rbp+274h]
  int v26; // [rsp+2F8h] [rbp+278h]
  int i; // [rsp+2FCh] [rbp+27Ch]

  _main();
  memset(v19, 0, sizeof(v19));
  memset(v20, 0, sizeof(v20));
  printf(&quot;Please input the key:&quot;, 32i64, v20);
  gets(&amp;Buffer);
  strcpy(Str2, &quot;a1dWT1pJXF1USVxRV1ZbUElQSVBJ&quot;);
  if ( !strcmp(&amp;Buffer, Str2) )
  {
    printf(&quot;Please input the flag:&quot;);
    gets(Str);
    v24 = strlen(Str);
    v3 = strlen(Str2);
    rc4_init(v19, Str2, v3);                    // rc4初始化
    for ( i = 0; i &lt;= 255; ++i )
      v20[i] = v19[i];
    rc4_crypt(v19, Str, v24);                   // 加密flag
    for ( i = 0; ; ++i )
    {
      v4 = i;
      if ( v4 &gt;= strlen(Str) )
        break;
      v6[i] = Str[i];                           // 复制flag
    }
    memset(&amp;v7, 0, 0x50ui64);
    v7 = 0xFFFFFF9D;
    v8 = 0xFFFFFF87;
    v9 = 0x71;
    v10 = 0xFFFFFFA4;
    v11 = 0xFFFFFF83;
    v12 = 0xB;
    v13 = 0xFFFFFFAA;
    v14 = 0x53;
    v15 = 0xFFFFFFC4;
    v16 = 0x38;
    v17 = 0x36;
    v18 = 0xFFFFFF85;
    v26 = 0;
    for ( j = 0; j &lt;= 11; ++j )                 // 比较flag
    {
      if ( v6[j] != *(&amp;v7 + j) )
        ++v26;
    }
    if ( v26 )
    {
      puts(&quot;Wrong!Please try again&quot;);
    }
    else
    {                                           // 解密刚刚加密后的flag
      rc4_crypt(v20, Str, v24);
      printf(&quot;Congratualtions!The flag is %s\n&quot;, Str);
    }
    system(&quot;pause&quot;);
  }
  else
  {
    printf(&quot;Wrong key!Please try again!&quot;);
    system(&quot;pause&quot;);
  }
  return 0;
}
</code></pre>
<p>分析可知为Rc4加密，动态调试获得密钥流：</p>
<pre><code class="bash">0xCD, 0x87, 0x7D, 0x96, 0x97, 0x0E, 0xAA, 0x05, 0xCC, 0x38, 0x39, 0x83
</code></pre>
<p>解密代码如下</p>
<pre><code class="python">In [1]: inputs = &quot;a&quot;*12

In [2]: key = [0xCD, 0x87, 0x7D, 0x96, 0x97, 0x0E, 0xAA, 0x05, 0xCC, 0x38, 0x39, 0x83]

In [3]: enc = [0x9D,0x87,0x71,0xA4,0x83,0xB,0xAA,0x53,0xC4,0x38,0x36,0x85]

In [4]: len(inputs)
Out[4]: 12

In [5]: len(key)
Out[5]: 12

In [6]: len(enc)
Out[6]: 12

In [7]: for i in range(0,12):
   ...:     print(chr(ord(&#39;a&#39;) ^ key[i] ^ enc[i]))
   ...:
1
a
m
S
u
d
a
7
i
a
n
g

In [8]: s = &#39;&#39;
   ...: for i in range(0,12):
   ...:     s += (chr(ord(&#39;a&#39;) ^ key[i] ^ enc[i]))
   ...:     print(s)
   ...:
1
1a
1am
1amS
1amSu
1amSud
1amSuda
1amSuda7
1amSuda7i
1amSuda7ia
1amSuda7ian
1amSuda7iang
</code></pre>
<p>flag:flag{1amSuda7iang}</p>
<p>….</p>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/ctf">ctf</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/iscc%20re">iscc re</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    


    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/popper/popper.min.js"></script>
<script src="/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="/lib/mdbootstrap/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
    <script src="/lib/tocbot/tocbot.min.js"></script>
  
  <script src="/js/post.js"></script>



  <script src="/lib/smoothscroll/SmoothScroll.min.js"></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Plugins -->


  
    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?926b66e71d8f61b2a08a4f0da34fef80";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-145389457-1', 'auto');
      ga('send', 'pageview');
    </script>
  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "ISCC 逆向 WP&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 50,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "left",
      visible: "false",
      
      icon: "❡"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  








</body>
</html>
